___INFO___

{
  "type": "TAG",
  "id": "cookiefirst",
  "version": 1,
  "securityGroups": [],
  "categories": [
    "TAG_MANAGEMENT",
    "PERSONALIZATION",
    "CONVERSIONS"
  ],
  "displayName": "CookieFirst CMP integration (Consent Mode)",
  "brand": {
    "id": "github.com_cookiefirst",
    "displayName": "cookiefirst",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIABAMAAAAGVsnJAAADKGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo0QUY1QkI3OUFGN0ExMUU5OTg4MUUzRUVEMDZCNUU1QSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo0QUY1QkI3QUFGN0ExMUU5OTg4MUUzRUVEMDZCNUU1QSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjRBRjVCQjc3QUY3QTExRTk5ODgxRTNFRUQwNkI1RTVBIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjRBRjVCQjc4QUY3QTExRTk5ODgxRTNFRUQwNkI1RTVBIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+N2+UIwAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAAnUExURUdw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\u003d\u003d"
  },
  "description": "Cookie First - Consent Management Platform (CMP). Manage cookies and other website tracking technologies conform privacy legislations, ie. GDPR, CCPA, LGPD. More: https://cookiefirst.com",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "LABEL",
    "name": "bannerSettings",
    "displayName": "Cookie First banner settings"
  },
  {
    "type": "TEXT",
    "name": "apiKey",
    "displayName": "API key",
    "simpleValueType": true,
    "help": "Fill your api key in, you can find it in the CookieFirst panel.",
    "valueValidators": [
      {
        "type": "NON_EMPTY",
        "errorMessage": "You need to enter a API key"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "urlPassThrough",
    "checkboxText": "Pass Ad Click Information Through URLs",
    "simpleValueType": true,
    "help": "When a visitor lands on an advertiserâ€™s website after clicking an ad, information about the ad might be appended to the landing page URLs as a query parameter.",
    "alwaysInSummary": true
  },
  {
    "type": "CHECKBOX",
    "name": "adsDataRedaction",
    "checkboxText": "Redact Ads Data",
    "simpleValueType": true,
    "help": "When ad_storage is denied, new cookies will not be set for advertising purposes. Additionally, third-party cookies previously set on google.com and doubleclick.net will not be used. Data sent to Google will still include the full page URL, including any ad click information in the URL parameters.",
    "alwaysInSummary": true
  },
  {
    "type": "TEXT",
    "name": "wait_for_update",
    "displayName": "Wait for update",
    "simpleValueType": true,
    "defaultValue": 2000,
    "help": "If you load Cookie First Async it might not always run before Google Tags, check and change this value if it\u0027s not working properly.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "NON_NEGATIVE_NUMBER"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "defaultSettings",
    "displayName": "Default Consent Mode settings",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "PARAM_TABLE",
        "name": "regionConfig",
        "displayName": "Region",
        "paramTableColumns": [
          {
            "param": {
              "type": "SELECT",
              "name": "functionalConsent",
              "displayName": "Functional (functionality_storage \u0026 personalization_storage)",
              "selectItems": [
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "granted",
                  "displayValue": "Granted"
                }
              ],
              "simpleValueType": true
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "performanceConsent",
              "displayName": "Analytics (analytics_storage)",
              "selectItems": [
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "granted",
                  "displayValue": "Granted"
                }
              ],
              "simpleValueType": true
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "advertisingConsent",
              "displayName": "Advertising (ad_storage)",
              "selectItems": [
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "granted",
                  "displayValue": "Granted"
                }
              ],
              "simpleValueType": true
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "TEXT",
              "name": "region",
              "displayName": "Region",
              "simpleValueType": true,
              "valueHint": "Region like US-CA or ES according to ISO 3166-2",
              "help": "Leave empty for All regions"
            },
            "isUnique": true
          }
        ],
        "editRowTitle": "Edit region",
        "newRowButtonText": "New region",
        "newRowTitle": "",
        "help": "Set the default consent mode settings. You can add different rules for different regions."
      }
    ],
    "help": "Set the default configuration for the Consent Mode types"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Require the necessary APIs
const logToConsole = require('logToConsole');
const injectScript = require('injectScript');
const queryPermission = require('queryPermission');
const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');
const callInWindow = require('callInWindow');
const gtagSet = require('gtagSet');
const getUrl = require('getUrl');
const JSON = require('JSON');
const localStorage = require('localStorage');  // Integrated the local storage API

const LOCALSTORAGE_ITEM_NAME = 'cookiefirst-consent';

// Get the API key the user input into the text field
const apiKey = data.apiKey;
if (!apiKey) {
    logToConsole('No API key provided.');
    data.gtmOnFailure();
    return;
}

const urlPassThrough = !!data.urlPassThrough;
const adsDataRedaction = !!data.adsDataRedaction;
const regionConfig = data.regionConfig || [];
const wait_for_update = data.wait_for_update;
let isDefaultStateFilled = false;

const getRegionArr = (regionStr) => {
    return regionStr.split(',')
        .map(region => region.trim())
        .filter(region => region.length !== 0);
};

const getConsentRegionData = (regionObject) => {
    const consentRegionData = {
        ad_storage: regionObject.advertisingConsent,
        analytics_storage: regionObject.performanceConsent,
        functionality_storage: regionObject.functionalConsent,
        personalization_storage: regionObject.functionalConsent,
        security_storage: 'granted'
    };

    const regionArr = getRegionArr(regionObject.region);
    if (regionArr.length) {
        consentRegionData.region = regionArr;
    }
    return consentRegionData;
};

let host;
if (queryPermission('get_url', 'host')) {
    host = getUrl('host');
}
if (!host) {
    logToConsole('No host URL provided.');
    data.gtmOnFailure();
    return;
}

const url = 'https://consent.cookiefirst.com/sites/' + host + '-' + apiKey + '/consent.js';
logToConsole(url);

const onSuccess = () => {
    data.gtmOnSuccess();
};

const onFailure = () => {
    data.gtmOnFailure();
};

const processConsentObject = (consentObject) => {
    const consentModeStates = {
        ad_storage: consentObject.advertising ? 'granted' : 'denied',
        analytics_storage: consentObject.performance ? 'granted' : 'denied',
        functionality_storage: consentObject.functional ? 'granted' : 'denied',
        personalization_storage: consentObject.functional ? 'granted' : 'denied',
        security_storage: 'granted'
    };
    logToConsole('consentModeStates: ', consentModeStates);
    updateConsentState(consentModeStates);
};

const main = () => {
    gtagSet({
        'developer_id.dNjAwYj': true,
        url_passthrough: urlPassThrough,
        ads_data_redaction: adsDataRedaction,
    });

    regionConfig.forEach(regionObj => {
        const consentRegionData = getConsentRegionData(regionObj);
        if (wait_for_update > 0) {
            consentRegionData.wait_for_update = wait_for_update;
        }
        setDefaultConsentState(consentRegionData);
        if (regionObj.region === undefined || regionObj.region.trim() === '') {
            isDefaultStateFilled = true;
        }
    });

    if (!isDefaultStateFilled) {
        const defaultState = {
            ad_storage: 'denied',
            analytics_storage: 'denied',
            functionality_storage: 'denied',
            personalization_storage: 'denied',
            security_storage: 'granted'
        };
        if (wait_for_update > 0) {
            defaultState.wait_for_update = wait_for_update;
        }
        setDefaultConsentState(defaultState);
    }

    // Fetch the consent data from local storage
    if (queryPermission('access_local_storage', 'read', LOCALSTORAGE_ITEM_NAME)) {
        const localStorageConsent = localStorage.getItem(LOCALSTORAGE_ITEM_NAME);
        if (localStorageConsent) {
            logToConsole('Local storage values: ', localStorageConsent);
            const consentObject = JSON.parse(localStorageConsent);
            processConsentObject(consentObject);
        }
    } else {
        logToConsole('No permission to read from local storage.');
    }

  // If the URL input by the user matches the permissions set for the template,
// inject the script with the onSuccess and onFailure methods as callbacks.
if (queryPermission('inject_script', url)) {
  injectScript(url, onSuccess, onFailure);
} else {
  logToConsole('Template: Script load failed due to permissions mismatch.');
  data.gtmOnFailure();
}
  /**
   * Add event listener to trigger update when consent changes
   */
  callInWindow('addCFGTMConsentListener', processConsentObject);
};

main();
logToConsole(data);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.cookiefirst.com/"
              },
              {
                "type": 1,
                "string": "https://*.cookiefirst.dev/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "developer_id.*"
              },
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "url_passthrough"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "host",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "cf_consent"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "addCFGTMConsentListener"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_local_storage",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "cookiefirst-consent"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []
setup: ''


___NOTES___

Created on 08/11/2021, 10:26:40


